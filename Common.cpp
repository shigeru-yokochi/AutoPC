// Common.cpp: implementation of the CCommon class.
//
//////////////////////////////////////////////////////////////////////

#include "stdafx.h"
#include "AutoPC.h"
#include "Common.h"
#include "DrawTool.h"




#define	LongToReal(x)	(x / 10000000.0)
#define	Pi	3.1415926535897932385
#define	RAD	(Pi / 180.0)
#define	XBaseFactor   1.11915337813215E-0005
#define	YBaseFactor  -8.99923618388130E-0006
//#define XBaseFactor   1.11902812113149E-0005
//#define YBaseFactor  -8.99823753465388E-0006


#define	XFact1	XBaseFactor
#define	YFact1	YBaseFactor
#define	LastString	"\xfe\xfe"

#ifdef _DEBUG
#undef THIS_FILE
static char THIS_FILE[]=__FILE__;
#define new DEBUG_NEW
#endif


const double SinTable[] = {
							0,
							0.0174524064372835,
							0.034899496702501,
							0.0523359562429438,
							0.0697564737441253,
							0.0871557427476582,
							0.104528463267653,
							0.121869343405147,
							0.139173100960065,
							0.156434465040231,
							0.17364817766693,
							0.190808995376545,
							0.207911690817759,
							0.224951054343865,
							0.241921895599668,
							0.258819045102521,
							0.275637355816999,
							0.292371704722737,
							0.309016994374947,
							0.325568154457157,
							0.342020143325669,
							0.3583679495453,
							0.374606593415912,
							0.390731128489274,
							0.4067366430758,
							0.422618261740699,
							0.438371146789077,
							0.453990499739547,
							0.469471562785891,
							0.484809620246337,
							0.5,
							0.515038074910054,
							0.529919264233205,
							0.544639035015027,
							0.559192903470747,
							0.573576436351046,
							0.587785252292473,
							0.601815023152048,
							0.615661475325658,
							0.629320391049837,
							0.642787609686539,
							0.656059028990507,
							0.669130606358858,
							0.681998360062499,
							0.694658370458997,
							0.707106781186548,
							0.719339800338651,
							0.73135370161917,
							0.743144825477394,
							0.754709580222772,
							0.766044443118978,
							0.777145961456971,
							0.788010753606722,
							0.798635510047293,
							0.809016994374947,
							0.819152044288992,
							0.829037572555042,
							0.838670567945424,
							0.848048096156426,
							0.857167300702112,
							0.866025403784439,
							0.874619707139396,
							0.882947592858927,
							0.891006524188368,
							0.898794046299167,
							0.90630778703665,
							0.913545457642601,
							0.92050485345244,
							0.927183854566787,
							0.933580426497202,
							0.939692620785908,
							0.945518575599317,
							0.951056516295154,
							0.956304755963035,
							0.961261695938319,
							0.965925826289068,
							0.970295726275996,
							0.974370064785235,
							0.978147600733806,
							0.981627183447664,
							0.984807753012208,
							0.987688340595138,
							0.99026806874157,
							0.992546151641322,
							0.994521895368273,
							0.996194698091746,
							0.997564050259824,
							0.998629534754574,
							0.999390827019096,
							0.999847695156391,
							1,
							0.999847695156391,
							0.999390827019096,
							0.998629534754574,
							0.997564050259824,
							0.996194698091746,
							0.994521895368273,
							0.992546151641322,
							0.99026806874157,
							0.987688340595138,
							0.984807753012208,
							0.981627183447664,
							0.978147600733806,
							0.974370064785235,
							0.970295726275996,
							0.965925826289068,
							0.961261695938319,
							0.956304755963035,
							0.951056516295154,
							0.945518575599317,
							0.939692620785908,
							0.933580426497202,
							0.927183854566787,
							0.92050485345244,
							0.913545457642601,
							0.90630778703665,
							0.898794046299167,
							0.891006524188368,
							0.882947592858927,
							0.874619707139396,
							0.866025403784439,
							0.857167300702112,
							0.848048096156426,
							0.838670567945424,
							0.829037572555042,
							0.819152044288992,
							0.809016994374947,
							0.798635510047293,
							0.788010753606722,
							0.777145961456971,
							0.766044443118978,
							0.754709580222772,
							0.743144825477394,
							0.73135370161917,
							0.719339800338651,
							0.707106781186548,
							0.694658370458997,
							0.681998360062499,
							0.669130606358858,
							0.656059028990507,
							0.642787609686539,
							0.629320391049837,
							0.615661475325658,
							0.601815023152048,
							0.587785252292473,
							0.573576436351046,
							0.559192903470747,
							0.544639035015027,
							0.529919264233205,
							0.515038074910054,
							0.5,
							0.484809620246337,
							0.469471562785891,
							0.453990499739547,
							0.438371146789077,
							0.422618261740699,
							0.4067366430758,
							0.390731128489274,
							0.374606593415912,
							0.3583679495453,
							0.342020143325669,
							0.325568154457157,
							0.309016994374947,
							0.292371704722737,
							0.275637355816999,
							0.258819045102521,
							0.241921895599668,
							0.224951054343865,
							0.207911690817759,
							0.190808995376545,
							0.17364817766693,
							0.156434465040231,
							0.139173100960065,
							0.121869343405147,
							0.104528463267653,
							0.0871557427476582,
							0.0697564737441253,
							0.0523359562429438,
							0.034899496702501,
							0.0174524064372835,
							-5.42101086242752E-20,
							-0.0174524064372835,
							-0.034899496702501,
							-0.0523359562429438,
							-0.0697564737441253,
							-0.0871557427476582,
							-0.104528463267653,
							-0.121869343405147,
							-0.139173100960065,
							-0.156434465040231,
							-0.17364817766693,
							-0.190808995376545,
							-0.207911690817759,
							-0.224951054343865,
							-0.241921895599668,
							-0.258819045102521,
							-0.275637355816999,
							-0.292371704722737,
							-0.309016994374947,
							-0.325568154457157,
							-0.342020143325669,
							-0.3583679495453,
							-0.374606593415912,
							-0.390731128489274,
							-0.4067366430758,
							-0.422618261740699,
							-0.438371146789077,
							-0.453990499739547,
							-0.469471562785891,
							-0.484809620246337,
							-0.5,
							-0.515038074910054,
							-0.529919264233205,
							-0.544639035015027,
							-0.559192903470747,
							-0.573576436351046,
							-0.587785252292473,
							-0.601815023152048,
							-0.615661475325658,
							-0.629320391049837,
							-0.642787609686539,
							-0.656059028990507,
							-0.669130606358858,
							-0.681998360062499,
							-0.694658370458997,
							-0.707106781186548,
							-0.719339800338651,
							-0.73135370161917,
							-0.743144825477394,
							-0.754709580222772,
							-0.766044443118978,
							-0.777145961456971,
							-0.788010753606722,
							-0.798635510047293,
							-0.809016994374947,
							-0.819152044288992,
							-0.829037572555042,
							-0.838670567945424,
							-0.848048096156426,
							-0.857167300702112,
							-0.866025403784439,
							-0.874619707139396,
							-0.882947592858927,
							-0.891006524188368,
							-0.898794046299167,
							-0.90630778703665,
							-0.913545457642601,
							-0.92050485345244,
							-0.927183854566787,
							-0.933580426497202,
							-0.939692620785908,
							-0.945518575599317,
							-0.951056516295154,
							-0.956304755963035,
							-0.961261695938319,
							-0.965925826289068,
							-0.970295726275996,
							-0.974370064785235,
							-0.978147600733806,
							-0.981627183447664,
							-0.984807753012208,
							-0.987688340595138,
							-0.99026806874157,
							-0.992546151641322,
							-0.994521895368273,
							-0.996194698091746,
							-0.997564050259824,
							-0.998629534754574,
							-0.999390827019096,
							-0.999847695156391,
							-1,
							-0.999847695156391,
							-0.999390827019096,
							-0.998629534754574,
							-0.997564050259824,
							-0.996194698091746,
							-0.994521895368273,
							-0.992546151641322,
							-0.99026806874157,
							-0.987688340595138,
							-0.984807753012208,
							-0.981627183447664,
							-0.978147600733806,
							-0.974370064785235,
							-0.970295726275996,
							-0.965925826289068,
							-0.961261695938319,
							-0.956304755963035,
							-0.951056516295154,
							-0.945518575599317,
							-0.939692620785908,
							-0.933580426497202,
							-0.927183854566787,
							-0.92050485345244,
							-0.913545457642601,
							-0.90630778703665,
							-0.898794046299167,
							-0.891006524188368,
							-0.882947592858927,
							-0.874619707139396,
							-0.866025403784439,
							-0.857167300702112,
							-0.848048096156426,
							-0.838670567945424,
							-0.829037572555042,
							-0.819152044288992,
							-0.809016994374947,
							-0.798635510047293,
							-0.788010753606722,
							-0.777145961456971,
							-0.766044443118978,
							-0.754709580222772,
							-0.743144825477394,
							-0.73135370161917,
							-0.719339800338651,
							-0.707106781186548,
							-0.694658370458997,
							-0.681998360062499,
							-0.669130606358858,
							-0.656059028990507,
							-0.642787609686539,
							-0.629320391049837,
							-0.615661475325658,
							-0.601815023152048,
							-0.587785252292473,
							-0.573576436351046,
							-0.559192903470747,
							-0.544639035015027,
							-0.529919264233205,
							-0.515038074910054,
							-0.5,
							-0.484809620246337,
							-0.469471562785891,
							-0.453990499739547,
							-0.438371146789077,
							-0.422618261740699,
							-0.4067366430758,
							-0.390731128489274,
							-0.374606593415912,
							-0.3583679495453,
							-0.342020143325669,
							-0.325568154457157,
							-0.309016994374947,
							-0.292371704722737,
							-0.275637355816999,
							-0.258819045102521,
							-0.241921895599668,
							-0.224951054343865,
							-0.207911690817759,
							-0.190808995376545,
							-0.17364817766693,
							-0.156434465040231,
							-0.139173100960065,
							-0.121869343405147,
							-0.104528463267653,
							-0.0871557427476582,
							-0.0697564737441253,
							-0.0523359562429438,
							-0.034899496702501,
							-0.0174524064372835,
							0};

const double CosTable[]={
							1,
							0.999847695156391,
							0.999390827019096,
							0.998629534754574,
							0.997564050259824,
							0.996194698091746,
							0.994521895368273,
							0.992546151641322,
							0.99026806874157,
							0.987688340595138,
							0.984807753012208,
							0.981627183447664,
							0.978147600733806,
							0.974370064785235,
							0.970295726275996,
							0.965925826289068,
							0.961261695938319,
							0.956304755963035,
							0.951056516295154,
							0.945518575599317,
							0.939692620785908,
							0.933580426497202,
							0.927183854566787,
							0.92050485345244,
							0.913545457642601,
							0.90630778703665,
							0.898794046299167,
							0.891006524188368,
							0.882947592858927,
							0.874619707139396,
							0.866025403784439,
							0.857167300702112,
							0.848048096156426,
							0.838670567945424,
							0.829037572555042,
							0.819152044288992,
							0.809016994374947,
							0.798635510047293,
							0.788010753606722,
							0.777145961456971,
							0.766044443118978,
							0.754709580222772,
							0.743144825477394,
							0.73135370161917,
							0.719339800338651,
							0.707106781186548,
							0.694658370458997,
							0.681998360062499,
							0.669130606358858,
							0.656059028990507,
							0.642787609686539,
							0.629320391049837,
							0.615661475325658,
							0.601815023152048,
							0.587785252292473,
							0.573576436351046,
							0.559192903470747,
							0.544639035015027,
							0.529919264233205,
							0.515038074910054,
							0.5,
							0.484809620246337,
							0.469471562785891,
							0.453990499739547,
							0.438371146789077,
							0.422618261740699,
							0.4067366430758,
							0.390731128489274,
							0.374606593415912,
							0.3583679495453,
							0.342020143325669,
							0.325568154457157,
							0.309016994374947,
							0.292371704722737,
							0.275637355816999,
							0.258819045102521,
							0.241921895599668,
							0.224951054343865,
							0.207911690817759,
							0.190808995376545,
							0.17364817766693,
							0.156434465040231,
							0.139173100960065,
							0.121869343405147,
							0.104528463267653,
							0.0871557427476582,
							0.0697564737441253,
							0.0523359562429438,
							0.034899496702501,
							0.0174524064372835,
							-2.71050543121376E-20,
							-0.0174524064372835,
							-0.034899496702501,
							-0.0523359562429438,
							-0.0697564737441253,
							-0.0871557427476582,
							-0.104528463267653,
							-0.121869343405147,
							-0.139173100960065,
							-0.156434465040231,
							-0.17364817766693,
							-0.190808995376545,
							-0.207911690817759,
							-0.224951054343865,
							-0.241921895599668,
							-0.258819045102521,
							-0.275637355816999,
							-0.292371704722737,
							-0.309016994374947,
							-0.325568154457157,
							-0.342020143325669,
							-0.3583679495453,
							-0.374606593415912,
							-0.390731128489274,
							-0.4067366430758,
							-0.422618261740699,
							-0.438371146789077,
							-0.453990499739547,
							-0.469471562785891,
							-0.484809620246337,
							-0.5,
							-0.515038074910054,
							-0.529919264233205,
							-0.544639035015027,
							-0.559192903470747,
							-0.573576436351046,
							-0.587785252292473,
							-0.601815023152048,
							-0.615661475325658,
							-0.629320391049837,
							-0.642787609686539,
							-0.656059028990507,
							-0.669130606358858,
							-0.681998360062499,
							-0.694658370458997,
							-0.707106781186548,
							-0.719339800338651,
							-0.73135370161917,
							-0.743144825477394,
							-0.754709580222772,
							-0.766044443118978,
							-0.777145961456971,
							-0.788010753606722,
							-0.798635510047293,
							-0.809016994374947,
							-0.819152044288992,
							-0.829037572555042,
							-0.838670567945424,
							-0.848048096156426,
							-0.857167300702112,
							-0.866025403784439,
							-0.874619707139396,
							-0.882947592858927,
							-0.891006524188368,
							-0.898794046299167,
							-0.90630778703665,
							-0.913545457642601,
							-0.92050485345244,
							-0.927183854566787,
							-0.933580426497202,
							-0.939692620785908,
							-0.945518575599317,
							-0.951056516295154,
							-0.956304755963035,
							-0.961261695938319,
							-0.965925826289068,
							-0.970295726275996,
							-0.974370064785235,
							-0.978147600733806,
							-0.981627183447664,
							-0.984807753012208,
							-0.987688340595138,
							-0.99026806874157,
							-0.992546151641322,
							-0.994521895368273,
							-0.996194698091746,
							-0.997564050259824,
							-0.998629534754574,
							-0.999390827019096,
							-0.999847695156391,
							-1,
							-0.999847695156391,
							-0.999390827019096,
							-0.998629534754574,
							-0.997564050259824,
							-0.996194698091746,
							-0.994521895368273,
							-0.992546151641322,
							-0.99026806874157,
							-0.987688340595138,
							-0.984807753012208,
							-0.981627183447664,
							-0.978147600733806,
							-0.974370064785235,
							-0.970295726275996,
							-0.965925826289068,
							-0.961261695938319,
							-0.956304755963035,
							-0.951056516295154,
							-0.945518575599317,
							-0.939692620785908,
							-0.933580426497202,
							-0.927183854566787,
							-0.92050485345244,
							-0.913545457642601,
							-0.90630778703665,
							-0.898794046299167,
							-0.891006524188368,
							-0.882947592858927,
							-0.874619707139396,
							-0.866025403784439,
							-0.857167300702112,
							-0.848048096156426,
							-0.838670567945424,
							-0.829037572555042,
							-0.819152044288992,
							-0.809016994374947,
							-0.798635510047293,
							-0.788010753606722,
							-0.777145961456971,
							-0.766044443118978,
							-0.754709580222772,
							-0.743144825477394,
							-0.73135370161917,
							-0.719339800338651,
							-0.707106781186548,
							-0.694658370458997,
							-0.681998360062499,
							-0.669130606358858,
							-0.656059028990507,
							-0.642787609686539,
							-0.629320391049837,
							-0.615661475325658,
							-0.601815023152048,
							-0.587785252292473,
							-0.573576436351046,
							-0.559192903470747,
							-0.544639035015027,
							-0.529919264233205,
							-0.515038074910054,
							-0.5,
							-0.484809620246337,
							-0.469471562785891,
							-0.453990499739547,
							-0.438371146789077,
							-0.422618261740699,
							-0.4067366430758,
							-0.390731128489274,
							-0.374606593415912,
							-0.3583679495453,
							-0.342020143325669,
							-0.325568154457157,
							-0.309016994374947,
							-0.292371704722737,
							-0.275637355816999,
							-0.258819045102521,
							-0.241921895599668,
							-0.224951054343865,
							-0.207911690817759,
							-0.190808995376545,
							-0.17364817766693,
							-0.156434465040231,
							-0.139173100960065,
							-0.121869343405147,
							-0.104528463267653,
							-0.0871557427476582,
							-0.0697564737441253,
							-0.0523359562429438,
							-0.034899496702501,
							-0.0174524064372835,
							1.89735380184963E-19,
							0.0174524064372835,
							0.034899496702501,
							0.0523359562429438,
							0.0697564737441253,
							0.0871557427476582,
							0.104528463267653,
							0.121869343405147,
							0.139173100960065,
							0.156434465040231,
							0.17364817766693,
							0.190808995376545,
							0.207911690817759,
							0.224951054343865,
							0.241921895599668,
							0.258819045102521,
							0.275637355816999,
							0.292371704722737,
							0.309016994374947,
							0.325568154457157,
							0.342020143325669,
							0.3583679495453,
							0.374606593415912,
							0.390731128489274,
							0.4067366430758,
							0.422618261740699,
							0.438371146789077,
							0.453990499739547,
							0.469471562785891,
							0.484809620246337,
							0.5,
							0.515038074910054,
							0.529919264233205,
							0.544639035015027,
							0.559192903470747,
							0.573576436351046,
							0.587785252292473,
							0.601815023152048,
							0.615661475325658,
							0.629320391049837,
							0.642787609686539,
							0.656059028990507,
							0.669130606358858,
							0.681998360062499,
							0.694658370458997,
							0.707106781186548,
							0.719339800338651,
							0.73135370161917,
							0.743144825477394,
							0.754709580222772,
							0.766044443118978,
							0.777145961456971,
							0.788010753606722,
							0.798635510047293,
							0.809016994374947,
							0.819152044288992,
							0.829037572555042,
							0.838670567945424,
							0.848048096156426,
							0.857167300702112,
							0.866025403784439,
							0.874619707139396,
							0.882947592858927,
							0.891006524188368,
							0.898794046299167,
							0.90630778703665,
							0.913545457642601,
							0.92050485345244,
							0.927183854566787,
							0.933580426497202,
							0.939692620785908,
							0.945518575599317,
							0.951056516295154,
							0.956304755963035,
							0.961261695938319,
							0.965925826289068,
							0.970295726275996,
							0.974370064785235,
							0.978147600733806,
							0.981627183447664,
							0.984807753012208,
							0.987688340595138,
							0.99026806874157,
							0.992546151641322,
							0.994521895368273,
							0.996194698091746,
							0.997564050259824,
							0.998629534754574,
							0.999390827019096,
							0.999847695156391,
							0};

double CCommon::sin(const double a)
{
	int i;

	i = (int)(a * 180.0 / Pi);
	i = (i+720) % 360;
	return SinTable[i];
}
double CCommon::cos(const double a)
{
	int i;

	i = (int)(a * 180.0 / Pi);
	i = (i+720) % 360;
	return CosTable[i];
}
void CCommon::SinCos(const double a, double *S, double *C)
{
	int i;

	i = (int)(a * 180.0 / Pi);
	i = (i+360) % 360;
    *S = SinTable[i];
    *C = CosTable[i];
	return ;
}


//***********************************************************************************
//*	コンストラクタ
//***********************************************************************************
CCommon::CCommon()
{
	XCenter		=0;
	YCenter		=0;

	XBase		=0.0;
	YBase		=0.0;

	MakeRad		=0;

	XFact		=0.0;
	YFact		=0.0;
	LineFact	=0.0;

	m_nMakeAngle	= 90;

}
//***********************************************************************************
//*	デストラクタ
//***********************************************************************************
CCommon::~CCommon()
{
}
//***********************************************************************************
//*	センター座標設定
//***********************************************************************************
void CCommon::SetCenter(long lx,long ly)
{
	XCenter		=lx;
	YCenter		=ly;
}
//***********************************************************************************
//*	ベース座標設定
//***********************************************************************************
void CCommon::SetBase(double dfx,double dfy)
{
	XBase		=dfx;
	YBase		=dfy;
}
//***********************************************************************************
//*	Xベース座標獲得
//***********************************************************************************
double CCommon::GetBaseX()
{
	return XBase;
}
//***********************************************************************************
//*	Yベース座標獲得
//***********************************************************************************
double CCommon::GetBaseY()
{
	return YBase;
}
//***********************************************************************************
//*	アングル設定
//***********************************************************************************
void CCommon::SetAngle(int nAngle/*=90*/)
{
	if(nAngle >= 360)nAngle=0;
	if(nAngle < 0)nAngle=0;

	m_nMakeAngle = nAngle;
	MakeRad = DegToRad(nAngle-90);

}
//***********************************************************************************
//*	アングル獲得
//***********************************************************************************
int CCommon::GetAngle()
{
	return m_nMakeAngle;
}
//***********************************************************************************
//*	アングル変化検査
//*	return FALSE:変化あり	TRUE:変化なし
//***********************************************************************************
BOOL CCommon::ChkAngle(int nAngle,int nReDrawAngle)
{
	int n2;
//	n1 = REDRAW_ANGLE;
	n2 = 360 - nReDrawAngle;
	
	int n = ((m_nMakeAngle - nAngle)+360)%360;
	if(n > n2 || n < nReDrawAngle)return TRUE;

	return FALSE;
}
//(******************************************************************************)
// 縮尺
void CCommon::SetFact(const int L)
{
	switch( L ){
		case 1:
			XFact = XBaseFactor*1000;
		    YFact = YBaseFactor*1000;
			LineFact = 1/1000;
		break;
		case 2:
			XFact = XBaseFactor*400;
            YFact = YBaseFactor*400;
            LineFact = 1/400;
		break;
		case 3:
            XFact = XBaseFactor*200;
            YFact = YBaseFactor*200;
            LineFact = 1/200;
		break;
		case 4:
            XFact = XBaseFactor*100;
            YFact = YBaseFactor*100;
            LineFact = 1/100;
		break;
		case 5:
            XFact = XBaseFactor*40;
            YFact = YBaseFactor*40;
            LineFact = 1/40;
		break;
		case 6:
            XFact = XBaseFactor*20;
            YFact = YBaseFactor*20;
            LineFact = 1/20;
		break;
		case 7:
            XFact = XBaseFactor*10;
            YFact = YBaseFactor*10;
            LineFact = 1/10;
		break;
		case 8:
            XFact = XBaseFactor*4;
            YFact = YBaseFactor*4;
            LineFact = 1/4;
		break;
		case 9:
            XFact = XBaseFactor*2;
            YFact = YBaseFactor*2;
            LineFact = 1/2;
		break;
		default :
            XFact = XBaseFactor;
            YFact = YBaseFactor;
            LineFact = 1;
		break;
	}
}
//(******************************************************************************)
//{ 緯度、経度をＸＹ座標にする }
POINT CCommon::RoadPoint(const long RX, const long RY)
{
	POINT	Result;

	Result.x = long((LongToReal(RX) - XBase) / XFact1) + XCenter;
    Result.y = long((LongToReal(RY) - YBase) / YFact1) + YCenter;
	return Result;
}

//(******************************************************************************)
//{ 緯度、経度をＸＹ座標にする }
POINT CCommon::ImagePoint(const long RX, const long RY)
{
	double	S, C,
			X, Y,
			A, R;
	POINT	Result;

  X = (LongToReal(RX) - XBase) / XFact;
  Y = (LongToReal(RY) - YBase) / YFact;
  A = atan2(Y, X) - MakeRad; //{A:Radian}
  R = sqrt(X*X + Y*Y);
  S = sin(A);
  C = cos(A);
  Result.x = long(C*R) + XCenter;
  Result.y = long(S*R) + YCenter;
  return Result; 
}


//(******************************************************************************)
POINT CCommon::GetXYPoint(const int L, const double E, const double N, const int XOff, const int YOff)
{
 long X, Y;
 POINT Result;

 switch( L ) {
 case 1:
   X = long(floor(E * 0.4));
      Y = long(floor(N * 0.4));
      X = X * 250;
      Y = Y * 250;
      X = X + XOff * 250;
      Y = Y + YOff * 250;
 break;
    case 2:
      X = long(floor(E * 1));
      Y = long(floor(N * 1));
      X = X * 100;
      Y = Y * 100;
      X = X + XOff * 100;
      Y = Y + YOff * 100;
 break;
    case 3:
      X = long(floor(E * 2));
      Y = long(floor(N * 2));
      X = X * 50;
   Y = Y * 50;
      X = X + XOff * 50;
      Y = Y + YOff * 50;
 break;
    case 4:
      X = long(floor(E * 4));
      Y = long(floor(N * 4));
      X = X * 25;
      Y = Y * 25;
      X = X + XOff * 25;
      Y = Y + YOff * 25;
 break;
    case 5:
      X = long(floor(E * 10));
      Y = long(floor(N * 10));
      X = X * 10;
      Y = Y * 10;
      X = X + XOff * 10;
      Y = Y + YOff * 10;
 break;
    case 6:
      X = long(floor(E * 20));
      Y = long(floor(N * 20));
      X = X * 5;
      Y = Y * 5;
      X = X + XOff * 5;
      Y = Y + YOff * 5;
 break;
    case 7:
      X = long(floor(E * 50));
      Y = long(floor(N * 50));
      X = X * 2;
      Y = Y * 2;
      X = X + XOff * 2;
      Y = Y + YOff * 2;
 break;
    case 8:
      X = long(floor(E * 100));
      Y = long(floor(N * 100));
      X = X + XOff;
      Y = Y + YOff;
 break;
    case 9:
      X = long(floor(E * 200));
      Y = long(floor(N * 200));
      X = X + XOff;
      Y = Y + YOff;
 break;
    default:
      X = long(floor(E * 350));
      Y = long(floor(N * 350));
      X = X + XOff;
      Y = Y + YOff;
 break;
 }

  Result.x = X;
  Result.y = Y;
  return Result;



/*
	long X, Y;
	POINT Result;

	switch( L ) {
	case 1:
	  X = long(floor(E * 0.2));
      Y = long(floor(N * 0.2));
      X = X * 500;
      Y = Y * 500;
      X = X + XOff * 500;
      Y = Y + YOff * 500;
	break;
    case 2:
      X = long(floor(E * 0.5));
      Y = long(floor(N * 0.5));
      X = X * 200;
      Y = Y * 200;
      X = X + XOff * 200;
      Y = Y + YOff * 200;
	break;
    case 3:
      X = long(floor(E));
      Y = long(floor(N));
      X = X * 100;
      Y = Y * 100;
      X = X + XOff * 100;
      Y = Y + YOff * 100;
	break;
    case 4:
      X = long(floor(E * 2));
      Y = long(floor(N * 2));
      X = X * 50;
      Y = Y * 50;
      X = X + XOff * 50;
      Y = Y + YOff * 50;
	break;
    case 5:
      X = long(floor(E * 5));
      Y = long(floor(N * 5));
      X = X * 20;
      Y = Y * 20;
      X = X + XOff * 20;
      Y = Y + YOff * 20;
	break;
    case 6:
      X = long(floor(E * 10));
      Y = long(floor(N * 10));
      X = X * 10;
      Y = Y * 10;
      X = X + XOff * 10;
      Y = Y + YOff * 10;
	break;
    case 7:
      X = long(floor(E * 20));
      Y = long(floor(N * 20));
      X = X * 5;
      Y = Y * 5;
      X = X + XOff * 5;
      Y = Y + YOff * 5;
	break;
    case 8:
      X = long(floor(E * 50));
      Y = long(floor(N * 50));
      X = X * 2;
      Y = Y * 2;
      X = X + XOff * 2;
      Y = Y + YOff * 2;
	break;
    case 9:
      X = long(floor(E * 100));
      Y = long(floor(N * 100));
      X = X + XOff;
      Y = Y + YOff;
	break;
    default:
      X = long(floor(E * 200));
      Y = long(floor(N * 200));
      X = X + XOff;
      Y = Y + YOff;
	break;
	}

  Result.x = X;
  Result.y = Y;
  return Result; 
*/
}
/******************************************************************************
*	タイルNo.獲得
*	nType　0:3.6.9用 1:1..10用
******************************************************************************/
void CCommon::GetTileNo(const int L, const double E, const double N, ULONG *SL,int nType)
{
	POINT P[25];
	int i, ll;

	if(nType == 0){
		switch( L ) {
			case 1: ll=1; break;
			case 2:
			case 3:
			case 4: ll=3; break;
			case 5:
			case 6:
			case 7: ll=6; break;
			case 8:
			case 9:
			case 10: ll=9; break;
			default:
				AfxMessageBox(L"GetTileNo()err");
				return;
		}
	}
	else{
		ll = L;
	}


	int Eoff = 0;
	if( E < 0 ) Eoff = 1;

    P[0] = GetXYPoint(ll, E, N,  0+Eoff,  0);
    P[1] = GetXYPoint(ll, E, N,  0+Eoff,  1);
    P[2] = GetXYPoint(ll, E, N,  0+Eoff, -1);
    P[3] = GetXYPoint(ll, E, N,  1+Eoff,  0);
    P[4] = GetXYPoint(ll, E, N,  1+Eoff,  1);
    P[5] = GetXYPoint(ll, E, N,  1+Eoff, -1);
    P[6] = GetXYPoint(ll, E, N, -1+Eoff,  0);
    P[7] = GetXYPoint(ll, E, N, -1+Eoff,  1);
    P[8] = GetXYPoint(ll, E, N, -1+Eoff, -1);

/*
    P[ 9] = GetXYPoint(ll, E, N, -2, -2);
    P[10] = GetXYPoint(ll, E, N, -2, -1);
    P[11] = GetXYPoint(ll, E, N, -2, -0);
    P[12] = GetXYPoint(ll, E, N, -2,  1);
    P[13] = GetXYPoint(ll, E, N, -2,  2);
    P[14] = GetXYPoint(ll, E, N,  2, -2);
    P[15] = GetXYPoint(ll, E, N,  2, -1);
    P[16] = GetXYPoint(ll, E, N,  2,  0);
    P[17] = GetXYPoint(ll, E, N,  2,  1);
    P[18] = GetXYPoint(ll, E, N,  2,  2);
    P[19] = GetXYPoint(ll, E, N,  1,  2);
    P[20] = GetXYPoint(ll, E, N,  0,  2);
    P[21] = GetXYPoint(ll, E, N, -1,  2);
    P[22] = GetXYPoint(ll, E, N,  1, -2);
    P[23] = GetXYPoint(ll, E, N,  0, -2);
    P[24] = GetXYPoint(ll, E, N, -1, -2);
*/
    for(i = 0; i <= 8; ++i) {
//    for(i = 0; i <= 24; i++) {
		SL[i] = P[i].x * 0x10000 + P[i].y;
	}
}


//(******************************************************************************)
double CCommon::DegToRad(const double D)
{
	return D * RAD;
}
//(******************************************************************************)
//*	仮想画面１の座標から経度緯度を求める
void CCommon::GetENPoint(const int X, const int Y,double *dfpEW,double *dfpNS)
{
    double S, C, A, R, dX, dY;

	dX = X - XCenter;
	dY = Y - YCenter;
    A = atan2(-(dY), dX) - DegToRad(m_nMakeAngle-90);//{A:Radian}
    R = sqrt(dX*dX + dY*dY);
    S = sin(A);
    C = cos(A);

    *dfpEW = XBase + XFact * C*R;
    *dfpNS = YBase - YFact * S*R;
}


CPoint CCommon::BMPPosition(double dfNewEW,double dfNewNS,int nGpsAngle)
{
    double A, R,E,N;
//	int X, Y;
	CPoint po;

    E = (dfNewEW  - XBase)  / XFact;
    N = (dfNewNS - YBase) / YFact;
//    E = (dfNewEW  - dfOldEW)  / XFact;
//    N = (dfNewNS - dfOldNS) / YFact;
    A = atan2(N, E) - DegToRad(nGpsAngle-90);
    R = sqrt(E*E + N*N);
    po.x = int(cos(A)*R);
    po.y = int(sin(A)*R);
  
	return po;
}



//(******************************************************************************)
POINT CCommon::DirectionPoint(const int X, const int Y, const int XC, const int YC)
{
	double	A, R;
	POINT	Result;

    A = atan2(Y-YC, X-XC) + DegToRad(m_nMakeAngle);
    R = sqrt((X-XC)*(X-XC) + (Y-YC)*(Y-YC));
    Result.x = XC + (int)(cos(A)*R);
    Result.y = YC - (int)(sin(A)*R);
	return Result;
}

//(******************************************************************************)
void CCommon::DrawSituation(CDC* pDC)
{
//                  'N',上, 右, 下, 左
const int X[] = {0, 33, 25, 49, 25,  1};
const int Y[] = {0, 25, 17, 25, 33, 25};
	POINT P;
	POINT pts[4];

//	Draw with a thick blue pen.
	CPen penBlack(PS_SOLID, 1, 0);
//	And a solid brush.
	CBrush brushRed(  RGB(255,   0,   0));
	CBrush brushWhite(RGB(255, 255, 255));

	CPen*	pOldPen		= pDC->SelectObject(&penBlack);
	CBrush*	pOldBrush	= pDC->SelectObject(&brushRed);

//    pDC->Ellipse(0, 0, 50, 50);//丸
    
	pts[0] = DirectionPoint(X[2], Y[2], 25, 25);
	pts[1] = DirectionPoint(X[3], Y[3], 25, 25);
	pts[2] = DirectionPoint(X[4], Y[4], 25, 25);
	pDC->Polygon(pts, 3);//北三角

	pDC->SelectObject(&brushWhite);
	pts[0] = DirectionPoint(X[2], Y[2], 25, 25);
	pts[1] = DirectionPoint(X[5], Y[5], 25, 25);
	pts[2] = DirectionPoint(X[4], Y[4], 25, 25);
	pDC->Polygon(pts, 3);//南三角

    P = DirectionPoint(X[1], Y[1], 25, 25);
    pDC->MoveTo(P.x-2, P.y+4);
    pDC->LineTo(P.x-2, P.y-4);
    pDC->LineTo(P.x+2, P.y+4);
    pDC->LineTo(P.x+2, P.y-4);// N

	pDC->SelectObject(pOldPen);
	pDC->SelectObject(pOldBrush);
}
//(******************************************************************************)
/*
void CCommon::DrawSituation(CDC* pDC)
{
//                  'N',上, 右, 下, 左
const int X[] = {0, 33, 25, 49, 25,  1};
const int Y[] = {0, 25, 17, 25, 33, 25};
	POINT P;
	POINT pts[4];


  // Draw with a thick blue pen.
	CPen penBlack(PS_SOLID, 1, RGB(0, 0, 0));
	CPen* pOldPen = pDC->SelectObject(&penBlack);

  // And a solid brush.
	CBrush brushRed(  RGB(255,   0,   0));
	CBrush brushWhite(RGB(255, 255, 255));

//    pDC->Ellipse(0, 0, 50, 50);//丸
    
	pts[0] = DirectionPoint(X[2], Y[2], 25, 25);
	pts[1] = DirectionPoint(X[3], Y[3], 25, 25);
	pts[2] = DirectionPoint(X[4], Y[4], 25, 25);
	pDC->SelectObject(&brushRed);
	pDC->Polygon(pts, 3);//北三角

	pts[0] = DirectionPoint(X[2], Y[2], 25, 25);
	pts[1] = DirectionPoint(X[5], Y[5], 25, 25);
	pts[2] = DirectionPoint(X[4], Y[4], 25, 25);
	pDC->SelectObject(&brushWhite);
	pDC->Polygon(pts, 3);//南三角

    P = DirectionPoint(X[1], Y[1], 25, 25);
    pDC->MoveTo(P.x-2, P.y+4);
    pDC->LineTo(P.x-2, P.y-4);
    pDC->LineTo(P.x+2, P.y+4);
    pDC->LineTo(P.x+2, P.y-4);// N

	pDC->SelectObject(pOldPen);

}
*/

/***********************************************************************************
*	縮尺表示
***********************************************************************************/
/*
void CCommon::PaintMapUnit(int nLevel,CDC *pDC, CRect rect)
{
	CString Str=L"????";
	switch( nLevel ) {
		case 1:  Str = L"25Km";break;
		case 2:  Str = L"10Km";break;
		case 3:  Str = L"5Km";break;
		case 4:  Str = L"2.5K";break;
		case 5:  Str = L"1Km";break;
		case 6:  Str = L"500m";break;
		case 7:  Str = L"250m";break;
		case 8:  Str = L"100m";break;
		case 9:  Str = L"50m";break;
		case 10: Str = L"25m";break;
	}


	int x1,x2,y1,y2;
	x1 = rect.right-10-25;
	x2 = rect.right-10;
	y1 = rect.bottom-10;
	y2 = rect.bottom-10;


	CDrawTool dt;
	dt.Line(pDC,x1,y1,x2,y2,	2,RGB(0,0,0));//down

	dt.Line(pDC,x1, y1-5,x1,y2,	2,RGB(0,0,0));//left
	dt.Line(pDC,x2, y1-5,x2,y2,	2,RGB(0,0,0));//right

	dt.TextOut(pDC,x1,y1-20,Str);

}
*/
/***********************************************************************************
*
***********************************************************************************/
char* CCommon::CStringToChar(CString Str)
{
	int n, i;
//	char m_s[1024];

	n = Str.GetLength();
	for(i = 0; i < n; i++) {
		m_s[i] = (char)Str.GetAt(i);
	}
	m_s[i] = 0;
	return &m_s[0];
}



/***********************************************************************************
*	
***********************************************************************************/
CString CCommon::RealToStr2(const double Num)
{
	CString Result;
	Result.Format(L"%0.0lf", floor(Num * DEF_CONVERT));
	return Result;
}
/***********************************************************************************
*	実画面の中心緯度経度よりその実画面の左上と右下の緯度経度を求める
***********************************************************************************/
void CCommon::GetDispArea2(double dfClientCenterEW,double dfClientCenterNS,
							  double *XS, double *YS, double *XE, double *YE)
{
	double A = 400;			//このドット分


	*XS = dfClientCenterEW - XFact * A;
	*YS = dfClientCenterNS - YFact * A;
	*XE = dfClientCenterEW + XFact * A;
	*YE = dfClientCenterNS + YFact * A;

	if( *XS > *XE ) {
		*XS = dfClientCenterEW + XFact * A;
		*XE = dfClientCenterEW - XFact * A;
	}
	if( *YS > *YE ) {
		*YS = dfClientCenterNS + YFact * A;
		*YE = dfClientCenterNS - YFact * A;
	}
}


//**************************************************************************
//	ラジアン→度に変える
//**************************************************************************
double CCommon::RadToDeg(const double Radians)
{
    return Radians * 180.0 / Pi;
}
//******************************************************************************
//EW0,NS0を基点にEW1,NS1方向のＧＰＳ角度を求める。
//(同じ値は設定しないこと)
//******************************************************************************
int CCommon::PointToGpsAngle(const double EW0,const double NS0,const double EW1,const double NS1)
{
    double A, X0, Y0, X1, Y1;

    X0 = ((EW0 - XBase) /  XFact1);
    Y0 = ((NS0 - YBase) / -YFact1);
    X1 = ((EW1 - XBase) /  XFact1);
    Y1 = ((NS1 - YBase) / -YFact1);
    A  = RadToDeg(atan2(Y1-Y0, X1-X0));    //atan2の結果はラジアン→度に変える
    return (int(90-A) + 360) % 360;                //0〜359度
}





//***************************************************************
//{ 緯度、経度をＸＹ座標にする }
POINT CCommon::XYPoint(const double RX, const double RY)
{
 POINT Result;

  Result.x = (int)((RX - XBase) / XFact1);
  Result.y = (int)((RY - YBase) / YFact1);
  return Result;
}
//**************************************************************
//ＸＹ座標を緯度、経度にする
void CCommon::XYToEN(const int X, const int Y, double *E, double *N)
{
  *E = XBase + XFact1 * X;
  *N = YBase + YFact1 * Y;
}

//**************************************************************
//直線２点間の緯度経度をｎ分割した座標（緯度経度）を求める
int CCommon::DecodeLine(const double EW0, const double NS0,const double EW1, const double NS1)
{
 double Spd, Len, R, A, S, C, E, N;
 POINT P1, P2;
 int i;

 DemoEW[0] = EW0;
 DemoNS[0] = NS0;

 P1 = XYPoint(EW0, NS0);
 P2 = XYPoint(EW1, NS1);
 E = P2.x - P1.x;
 N = P2.y - P1.y;

 Len = sqrt(E*E + N*N);
 A = atan2(P2.y-P1.y, P2.x-P1.x);
 Spd = 14;    //秒速14メートル→(50Km/h)/3.6 ≒ 14m/Sec
 R = Spd;
 S = sin(A);
 C = cos(A);
 i = 1;
 while( Len > R ){
  XYToEN((int)(C*R + P1.x), (int)(S*R + P1.y), &E, &N);
    DemoEW[i] = E;
  DemoNS[i] = N;
  ++i;
  R = R + Spd;
 }
 return i;    //i個
}

//**************************************************************
//直線緯度経度間の指定距離位置獲得
POINT CCommon::DistancePoint(const int EW0, const int NS0,const int EW1, const int NS1,const int Distance)
{
 double Len, R, A, S, C, E, N;
 POINT P1, P2, Result;


 P1 = XYPoint(LongToReal(EW0), LongToReal(NS0));
 P2 = XYPoint(LongToReal(EW1), LongToReal(NS1));
 E = P2.x - P1.x;
 N = P2.y - P1.y;

 Len = sqrt(E*E + N*N);
 if( Len < Distance ) { // 終点より先が必要ならこれはいらない
  Result.x = 0;
  Result.y = 0;
  return Result;
 }
 A = atan2(P2.y-P1.y, P2.x-P1.x);
 R = Distance;
 S = sin(A);
 C = cos(A);
 XYToEN((int)(C*R + P1.x), (int)(S*R + P1.y), &E, &N);
 Result.x = (int)(E * DEF_CONVERT);
 Result.y = (int)(N * DEF_CONVERT);
 return Result;
}
